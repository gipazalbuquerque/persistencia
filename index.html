<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Locais de Medita√ß√£o Pr√≥ximos</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

  <!-- Firebase (compat) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    :root {
      --gradA: #667eea; --gradB: #764ba2; --gradC: #4facfe; --gradD: #00f2fe;
      --bg: #f5f7fb; --text: #222; --muted: #6b7280; --card: #fff;
      --ring: rgba(79, 172, 254, .15);
    }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
           background: linear-gradient(135deg, var(--gradA), var(--gradB)); min-height: 100vh; padding: 20px; }
    .container { max-width: 1280px; margin: 0 auto; background: rgba(255,255,255,.95); border-radius: 20px; overflow: hidden;
                 box-shadow: 0 20px 40px rgba(0,0,0,.12); backdrop-filter: blur(10px); }
    .header { background: linear-gradient(135deg, var(--gradC), var(--gradD)); color:#fff; padding: 28px 24px; text-align:center; }
    .header h1 { margin: 0 0 6px; font-size: 2rem; text-shadow: 0 2px 4px rgba(0,0,0,.25); }
    .header p { margin: 0; opacity: .92; }

    .content { display: grid; grid-template-columns: 400px 1fr; min-height: 680px; }
    @media (max-width: 900px) { .content { grid-template-columns: 1fr; } }

    .left { padding: 22px; background: var(--bg); border-right: 1px solid #e5e7eb; }
    .section { background: var(--card); border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,.06); }
    .section h3 { margin: 0 0 10px; font-size: 1rem; color: var(--text); }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .field { display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; }
    label { font-weight: 600; font-size: .92rem; color: #374151; }
    input, select, textarea { padding: 12px 14px; border-radius: 12px; border: 2px solid #e5e7eb; background: #fafbfc; font-size: .96rem; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--gradC); box-shadow: 0 0 0 4px var(--ring); background: #fff; }
    textarea { min-height: 92px; resize: vertical; }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 16px; border: 0; border-radius: 12px;
           font-weight: 700; cursor: pointer; transition: transform .1s ease, box-shadow .2s ease; }
    .btn-primary { color:#fff; background: linear-gradient(135deg, var(--gradA), var(--gradB)); box-shadow: 0 6px 20px rgba(102,126,234,.35); }
    .btn-ghost { background: #eef2ff; color: #3730a3; font-weight: 600; }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { opacity:.6; cursor:not-allowed; transform:none; }

    .help { font-size: .86rem; color: var(--muted); }

    #map { height: 100%; min-height: 680px; }

    .results { display: grid; gap: 8px; max-height: 260px; overflow: auto; }
    .card { background: #fff; border-radius: 12px; padding: 12px; border: 1px solid #e5e7eb; }
    .card .title { font-weight: 700; margin: 0 0 4px; }
    .card .meta { font-size: .86rem; color: var(--muted); }
    .pill { display:inline-block; padding: 2px 8px; font-size: .78rem; border-radius: 999px; border:1px solid #e5e7eb; background:#f9fafb; margin-right: 6px; }

    .status { margin-top: 12px; padding: 10px; border-radius: 12px; font-weight: 600; text-align: center; opacity: 0; transition: all .25s ease; }
    .status.show { opacity: 1; transform: translateY(-2px); }
    .status.ok { background: linear-gradient(135deg, var(--gradC), var(--gradD)); color:#fff; }
    .status.err { background: linear-gradient(135deg, #ff6b6b, #ee5a24); color:#fff; }

    .tip { font-size:.8rem; color:#6b7280; margin-top:6px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üßò‚Äç‚ôÄÔ∏è Encontre locais de medita√ß√£o perto de voc√™</h1>
      <p>Busque por endere√ßo ou use sua localiza√ß√£o. Veja no mapa e na lista os pontos mais pr√≥ximos.</p>
    </div>

    <div class="content">
      <!-- Painel esquerdo -->
      <aside class="left">
        <!-- Busca -->
        <section class="section">
          <h3>üîé Buscar ponto pr√≥ximo</h3>
          <div class="field">
            <label for="address">Endere√ßo ou bairro</label>
            <input id="address" type="text" placeholder="Ex.: Av. Paulista, 1000, S√£o Paulo" />
            <div class="row">
              <button id="btnGeocode" class="btn btn-ghost" type="button">Buscar endere√ßo</button>
              <button id="btnMyLoc" class="btn btn-primary" type="button">Usar minha localiza√ß√£o</button>
            </div>
            <p class="help">Dica: voc√™ pode digitar o endere√ßo completo, CEP ou ponto de refer√™ncia.</p>
          </div>
          <div class="row-3">
            <div class="field">
              <label for="radius">Raio</label>
              <select id="radius">
                <option value="1">1 km</option>
                <option value="3">3 km</option>
                <option value="5" selected>5 km</option>
                <option value="10">10 km</option>
                <option value="20">20 km</option>
              </select>
            </div>
            <div class="field">
              <label for="limit">M√°x. resultados</label>
              <select id="limit">
                <option>5</option>
                <option selected>10</option>
                <option>20</option>
                <option>50</option>
              </select>
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button id="btnSearch" class="btn btn-primary" type="button">Mostrar pr√≥ximos</button>
            </div>
          </div>
          <div id="searchStatus" class="status"></div>
        </section>

        <!-- Resultados -->
        <section class="section">
          <h3>üìç Resultados pr√≥ximos</h3>
          <div id="results" class="results"></div>
          <p class="tip">Clique em um item para centralizar o mapa. "Rotas" abre o Google Maps com dire√ß√µes.</p>
        </section>

        <!-- Cadastro r√°pido (admin simples) -->
        <section class="section">
          <h3>‚ûï Cadastrar novo local</h3>
          <div class="field"><label for="locName">Nome do local</label><input id="locName" placeholder="Ex.: Pra√ßa da √Årvore ‚Äì Grupo Falun Dafa" /></div>
          <div class="field"><label for="locDesc">Descri√ß√£o/Observa√ß√µes</label><textarea id="locDesc" placeholder="Dias, hor√°rios, ponto de encontro, contato‚Ä¶"></textarea></div>
          <div class="row">
            <div class="field"><label for="locLat">Latitude</label><input id="locLat" type="number" step="any" placeholder="-23.5" /></div>
            <div class="field"><label for="locLng">Longitude</label><input id="locLng" type="number" step="any" placeholder="-46.6" /></div>
          </div>
          <div class="row">
            <button id="btnPickFromMap" class="btn btn-ghost" type="button">Pegar do mapa</button>
            <button id="btnSaveLoc" class="btn btn-primary" type="button">Salvar local</button>
          </div>
          <div id="saveStatus" class="status"></div>
        </section>
      </aside>

      <!-- Mapa -->
      <main>
        <div id="map"></div>
      </main>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

  <script>
    // =============================
    //  CONFIGURA√á√ÉO DO FIREBASE
    //  Substitua pelos seus valores ‚Äì evite expor chaves sens√≠veis em reposit√≥rios p√∫blicos.
    // =============================
    const firebaseConfig = {
      apiKey: "AIzaSyDfDHknknll6FFgaDjA0Hqavvcw5nmJhnw",
      authDomain: "projeto-01-eecc9.firebaseapp.com",
      projectId: "projeto-01-eecc9",
      storageBucket: "projeto-01-eecc9.firebasestorage.app",
      messagingSenderId: "345935062507",
      appId: "1:345935062507:web:acc73f4af80223a5e9a5ae"
    };

    let db = null;
    try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); }
    catch (e) { console.error('Firebase init error', e); }

    // =============================
    //  MAPA
    // =============================
    const map = L.map('map').setView([-23.5505, -46.6333], 12); // SP como fallback
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors', maxZoom: 19
    }).addTo(map);

    const markersLayer = L.layerGroup().addTo(map);
    let originMarker = null;   // marcador da origem (usu√°rio/endere√ßo)
    let radiusCircle = null;   // c√≠rculo de raio

    function status(el, msg, ok=true) {
      el.textContent = msg; el.className = `status ${ok ? 'ok' : 'err'} show`;
      setTimeout(()=> el.classList.remove('show'), 3500);
    }

    function addOrigin(lat, lng) {
      if (originMarker) map.removeLayer(originMarker);
      originMarker = L.marker([lat,lng], { title: 'Origem' }).addTo(map);
      map.setView([lat,lng], 14);
    }

    function drawRadius(lat, lng, km) {
      if (radiusCircle) map.removeLayer(radiusCircle);
      radiusCircle = L.circle([lat, lng], { radius: km * 1000, color: '#3b82f6', weight: 2, fillOpacity: .07 }).addTo(map);
    }

    // Haversine (dist√¢ncia em km)
    function haversine(aLat, aLng, bLat, bLng) {
      const toRad = d => d * Math.PI / 180;
      const R = 6371; // km
      const dLat = toRad(bLat - aLat);
      const dLng = toRad(bLng - aLng);
      const s1 = Math.sin(dLat/2) ** 2;
      const s2 = Math.cos(toRad(aLat)) * Math.cos(toRad(bLat)) * (Math.sin(dLng/2) ** 2);
      return 2 * R * Math.asin(Math.sqrt(s1 + s2));
    }

    // =============================
    //  CARREGAR LOCAIS DO FIRESTORE
    //  Cole√ß√£o: 'locations'  (campos recomendados)
    //   - name: string
    //   - description: string
    //   - lat: number
    //   - lng: number
    //   - schedule: string (opcional)
    //   - tags: array<string> (opcional)
    // =============================
    async function loadLocations() {
      if (!db) { return []; }
      const snap = await db.collection('locations').get();
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    function renderMarkers(locs) {
      markersLayer.clearLayers();
      locs.forEach(loc => {
        const m = L.marker([loc.lat, loc.lng]).addTo(markersLayer);
        const html = `
          <b>${loc.name ?? 'Local sem nome'}</b><br/>
          ${loc.description ? `<div style="margin:6px 0">${loc.description}</div>` : ''}
          ${loc.schedule ? `<div><b>Hor√°rios:</b> ${loc.schedule}</div>` : ''}
          <div style="margin-top:8px"><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination=${loc.lat},${loc.lng}">Rotas no Google Maps</a></div>
        `;
        m.bindPopup(html);
      });
    }

    function renderResults(list, origin) {
      const box = document.getElementById('results');
      box.innerHTML = '';
      if (!list.length) { box.innerHTML = '<div class="help">Nenhum local encontrado nesse raio.</div>'; return; }
      list.forEach(item => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="title">${item.name}</div>
          <div class="meta">${item.distance.toFixed(2)} km ‚Ä¢ ${item.description ?? ''}</div>
          ${ item.schedule ? `<div class="pill">Hor√°rios: ${item.schedule}</div>` : '' }
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn btn-ghost" data-center="${item.lat},${item.lng}">Ver no mapa</button>
            <a class="btn btn-primary" target="_blank" href="https://www.google.com/maps/dir/?api=1&origin=${origin.lat},${origin.lng}&destination=${item.lat},${item.lng}">Rotas</a>
          </div>
        `;
        div.querySelector('button[data-center]')?.addEventListener('click', (ev) => {
          const [lat,lng] = ev.currentTarget.dataset.center.split(',').map(Number);
          map.setView([lat,lng], 16);
        });
        box.appendChild(div);
      });
    }

    // Core da busca: recebe origem e aplica raio/limite
    function nearest(origin, locs, km, limit) {
      const withDist = locs.map(l => ({ ...l, distance: haversine(origin.lat, origin.lng, l.lat, l.lng) }))
                           .filter(l => !Number.isNaN(l.distance) && l.distance <= km)
                           .sort((a,b) => a.distance - b.distance)
                           .slice(0, limit);
      return withDist;
    }

    // =============================
    //  GEOCODING (Nominatim/OSM) ‚Äì uso leve, sujeito a limites. Considere um servi√ßo com chave para produ√ß√£o.
    // =============================
    async function geocode(q) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1&addressdetails=1`;
      const resp = await fetch(url, { headers: { 'Accept-Language': 'pt-BR' } });
      if (!resp.ok) throw new Error('Falha ao geocodificar');
      const data = await resp.json();
      if (!data.length) throw new Error('Endere√ßo n√£o encontrado');
      const { lat, lon } = data[0];
      return { lat: parseFloat(lat), lng: parseFloat(lon) };
    }

    // =============================
    //  UI HANDLERS
    // =============================
    let allLocations = [];
    let lastClickedLatLng = null; // para pegar lat/lng do mapa no cadastro

    // Marcar clique no mapa para auxiliar cadastro
    map.on('click', (e) => { lastClickedLatLng = e.latlng; });

    // Inicializa√ß√£o: tentar pegar geolocaliza√ß√£o do usu√°rio e carregar locais
    (async function init() {
      try {
        allLocations = await loadLocations();
        renderMarkers(allLocations);
      } catch (e) { console.warn('N√£o foi poss√≠vel carregar locations:', e); }

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude, lng = pos.coords.longitude;
          addOrigin(lat, lng);
          map.setView([lat,lng], 14);
        }, () => {/* ignore */});
      }
    })();

    // Bot√£o: geocodificar endere√ßo
    document.getElementById('btnGeocode').addEventListener('click', async () => {
      const q = document.getElementById('address').value.trim();
      const statusEl = document.getElementById('searchStatus');
      if (!q) return status(statusEl, 'Digite um endere√ßo para buscar', false);
      try {
        status(statusEl, 'Localizando endere√ßo‚Ä¶');
        const { lat, lng } = await geocode(q);
        addOrigin(lat, lng);
        status(statusEl, 'Endere√ßo encontrado. Agora clique em "Mostrar pr√≥ximos".');
      } catch (e) {
        status(statusEl, e.message || 'N√£o foi poss√≠vel encontrar esse endere√ßo', false);
      }
    });

    // Bot√£o: usar minha localiza√ß√£o
    document.getElementById('btnMyLoc').addEventListener('click', async () => {
      const statusEl = document.getElementById('searchStatus');
      if (!navigator.geolocation) return status(statusEl, 'Geolocaliza√ß√£o n√£o suportada neste navegador', false);
      status(statusEl, 'Obtendo sua localiza√ß√£o‚Ä¶');
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        addOrigin(lat, lng);
        status(statusEl, 'Localiza√ß√£o definida. Agora clique em "Mostrar pr√≥ximos".');
      }, () => status(statusEl, 'N√£o foi poss√≠vel obter sua localiza√ß√£o', false));
    });

    // Bot√£o: mostrar pr√≥ximos
    document.getElementById('btnSearch').addEventListener('click', () => {
      const statusEl = document.getElementById('searchStatus');
      const r = parseFloat(document.getElementById('radius').value);
      const limit = parseInt(document.getElementById('limit').value, 10);
      if (!originMarker) return status(statusEl, 'Defina uma origem (endere√ßo ou sua localiza√ß√£o).', false);
      const { lat, lng } = originMarker.getLatLng();
      drawRadius(lat, lng, r);
      const list = nearest({ lat, lng }, allLocations, r, limit);
      renderResults(list, { lat, lng });
      renderMarkers(allLocations); // re-render para manter todos no mapa
      status(statusEl, list.length ? `Encontrados ${list.length} locais dentro de ${r} km` : 'Nenhum local nesse raio', !!list.length);
    });

    // Cadastro: pegar do mapa
    document.getElementById('btnPickFromMap').addEventListener('click', () => {
      const saveEl = document.getElementById('saveStatus');
      if (!lastClickedLatLng) return status(saveEl, 'Clique no mapa primeiro para capturar as coordenadas.', false);
      document.getElementById('locLat').value = lastClickedLatLng.lat.toFixed(6);
      document.getElementById('locLng').value = lastClickedLatLng.lng.toFixed(6);
      status(saveEl, 'Coordenadas preenchidas a partir do mapa.');
    });

    // Cadastro: salvar no Firestore
    document.getElementById('btnSaveLoc').addEventListener('click', async () => {
      const name = document.getElementById('locName').value.trim();
      const description = document.getElementById('locDesc').value.trim();
      const lat = parseFloat(document.getElementById('locLat').value);
      const lng = parseFloat(document.getElementById('locLng').value);
      const saveEl = document.getElementById('saveStatus');

      if (!name || Number.isNaN(lat) || Number.isNaN(lng)) return status(saveEl, 'Preencha nome, latitude e longitude.', false);
      if (!db) return status(saveEl, 'Firebase n√£o configurado.', false);

      try {
        const doc = { name, description, lat, lng, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
        const ref = await db.collection('locations').add(doc);
        status(saveEl, 'Local salvo com sucesso!');
        // adicionar no array e no mapa
        allLocations.push({ id: ref.id, ...doc });
        renderMarkers(allLocations);
        // limpar campos
        ['locName','locDesc','locLat','locLng'].forEach(id => document.getElementById(id).value = '');
      } catch (e) {
        console.error(e); status(saveEl, 'Erro ao salvar local. Verifique as regras do Firestore.', false);
      }
    });
  </script>
</body>
</html>


